#!/bin/bash
#
# Copyright 2012 -- Andrew Davies <a.w.davies.vio@gmail.com>
#
# This script allows the user to setup python in a virtual
# environment so that pip (a python package installer) can install
# the latest git version of django on the computer without need for
# root permissions.
#
# README:
#
# The script works as follows:
#
# 1.) The script first downloads the latest version of django
#     from the git repo.  This will be checked out to the global
#     trunk variable.  Make sure the script is in the folder you'd
#     like to have contain your trunk folder.  
#
#     For example, if one wanted to have their django install
#     to be in the "/home/user/cowdung/" folder, you would copy
#     the script into "/home/user/cowdung/" and run it in there.
#     
#     You would then have a folder called "django-trunk" (by default)
#     in the "/home/user/cowdung/" folder.  It is recommended to keep
#     the folder so that one can update django later.
#
# 2.) A folder is created in the user's home directory called PYENV.
#     this will serve as a virtual environment for python, and will
#     be the location of the virtual python environment and the django
#     installation (more description on a virtual environment and how
#     to use it (and love it!) follows).
#
# 3.) After the virtual environment is installed, pip (a python package
#     installer) is used to install django from the folder that was
#     downloaded from git (at the user's discretion, of course).  It 
#     will be installed in the python package folder within the PYENV folder.
#
#


ENV="`eval echo ~`/PYENV"
TRUNK="django-trunk"
SOURCE="https://github.com/django/django.git"

if [ -d $TRUNK ]; then
	echo "NOTE: $TRUNK exists.  Checking for updates"
	if [ ! -d $TRUNK/.git ]; then
		echo "NOTE: No '.git' file found in $TRUNK"
		echo "NOTE: Either edit the TRUNK name in this script"
		echo "NOTE: Or remove $TRUNK"
	else
		echo "NOTE: '.git' file found.  Attempting update."
		echo "NOTE: Entering $TRUNK"
		cd $TRUNK
		git pull
		echo "NOTE: Leaving $TRUNK"
		cd ../
		if [ ! $? ]; then
			echo "ERROR: git pull.  Exiting"
			exit 1
		fi
	fi
else
	echo "NOTE: Checking out $TRUNK"
	git clone $SOURCE $TRUNK

	if [ ! $? ]; then
		echo "ERROR: Some git error occured. Exiting..."
		exit 1
	fi
fi

if [ -d $ENV ]; then
	echo "NOTE: $ENV dir exists.  Skipping virtualenv setup."
	echo "NOTE: If this isn't correct, simply remove the"
	echo "NOTE:   directory at $ENV"
else
	# Set up a virtual ENV that is in the home folder.
	virtualenv $ENV

	if [ ! $? ]; then
		echo "ERROR: virtual env.  Exiting..."
		exit 1
	fi
fi

echo
read -p "Install/Update Django? (y/n) "
[ "$REPLY" == "n" ] || $ENV/bin/pip install -e "$TRUNK"
echo
echo "NOTE: If you want to run python with the virtual env"
echo "NOTE: Run '~/PYENV/bin/python'"
echo "NOTE: Django has been set up to do this by default."
